{"title":"Teste de funcionalidade ***Quarto***\npara sítio eletrônico com recursos interativos","markdown":{"yaml":{"title":"Teste de funcionalidade ***Quarto***\npara sítio eletrônico com recursos interativos","author":"Joaquim","date":"12/19/2022","format":{"html":{"code-fold":true,"fig-height":4,"fig-width":5}}},"headingText":"Dados de alertas de risco de desastres enviados pelo CEMADEN.","containsRefs":false,"markdown":"\n\nA ideia é juntar a divulgação \"estática\" — com uma breve explanação de um conjunto de variáveis das BATERs relacionadas num tema, com revisão na bibliografia do uso dessas variáveis e outras considerações, analisando os resultados observados na escala nacional e de grandes regiões, podendo citar alguns casos de UF — com uma parte interativa, disponibilizando os dados agregados por UF e município, juntamente com um mapa com as BATERs do município selecionado com as feições *clicáveis*, abrindo uma caixinha de texto com as informações básicas da BATER e as variáveis da mesma exploradas no tema da publicação.\n\n## Processamento dos dados através do *R*\n\n### Bibliotecas\nCarrega as bibliotecas necessárias. São muitas, nesse caso.\n\n```{r}\n#| warning: false\n\nlibrary(tidyverse)\nlibrary(readxl)\nlibrary(writexl)\nlibrary(sf)\nlibrary(fuzzyjoin)\nlibrary(clock)\nlibrary(ggthemes)\nlibrary(showtext)\nlibrary(RColorBrewer)\n\n```\n\n### Dados\nCarrega a tabela do Excel com os dados.\n```{r}\n#| warning: false\n\nplanilha <- read_excel(\"W:/DGC_ACERVO_CGEO/PROJETOS_EM_ANDAMENTO/Cemaden/BOLSISTAS/Joaquim/AtlasNacional/Alertas/AlertasCemaden2012-2021.xlsx\")\n\n```\n\n### Agregação\nProduz a tabela de total de alertas por município.\n```{r}\n#| warning: false\n\nTot_Mun <- planilha %>%\n  group_by(`Código IBGE`, Evento) %>%\n  summarise(Tot_Event = n()) %>%\n  mutate(Evento = ifelse(Evento == \"Geo/Hidro\", \"Hidrogeo\", Evento)) %>%\n  pivot_wider(names_from = Evento, values_from = Tot_Event, values_fill = 0) %>%\n  mutate(tot_geo = Geo + Hidrogeo, tot_hidro = Hidro + Hidrogeo)\n\n```\n\n### Processamento\nCalcula as médias mensais por grande região e país e junta tudo numa mesma tabela, *Med_Geral*.\n```{r}\n#| warning: false\n\nMed_GdReg_data <- planilha %>%\n  mutate(dataref = date_group(as.Date(planilha$Data), \"month\"),\n         mes = factor(date_format(dataref, format = \"%m\"), \n                      labels = c(\"Jan\", \"Fev\", \"Mar\", \"Abr\", \"Mai\", \"Jun\", \"Jul\", \"Ago\", \"Set\", \"Out\", \"Nov\", \"Dez\")),\n         GdReg = factor(as.numeric(substr(`Código IBGE`, 1, 1)), labels = c(\"N\", \"NE\", \"SE\", \"S\", \"CO\")),\n         geologico = ifelse(Evento %in% c(\"Geo\", \"Geo/Hidro\"), 1, 0),\n         hidrologico = ifelse(Evento %in% c(\"Hidro\", \"Geo/Hidro\"), 1, 0)) %>%\n  group_by(GdReg, mes, dataref) %>%\n  summarise(Tot_Event = n(), Tot_geo = sum(geologico), Tot_hidro = sum(hidrologico)) %>%\n  ungroup() %>%\n  group_by(GdReg, mes) %>%\n  summarise(Media_geo = mean(Tot_geo), Media_hidro = mean(Tot_hidro), Media_Event = mean(Tot_Event)) %>%\n  # manobra esquisita para arrumar a tabela, rever esse código adiante de pivotagem\n  pivot_longer(cols = starts_with(\"Media_\"), names_to = \"Tipo\", values_to = \"Media\") %>%\n  pivot_wider(names_from = c(\"mes\", \"Tipo\"), values_from = Media, values_fill = 0) %>%\n  pivot_longer(cols = !GdReg, names_to = c(\"mes\", \"Tipo\"), names_pattern = \"(.*)_Media_(.*)\", values_to = \"Media\") %>%\n  # até aqui.\n  ungroup() %>%\n  group_by(Tipo, mes) %>%\n  mutate(mes = factor(mes, levels = c(\"Jan\", \"Fev\", \"Mar\", \"Abr\", \"Mai\", \"Jun\", \"Jul\", \"Ago\", \"Set\", \"Out\", \"Nov\", \"Dez\")))\n\n\nMed_Pais_geral <- Med_GdReg_data %>%\n  group_by(Tipo, mes) %>%\n  summarise(Media = sum(Media)) %>%\n  mutate(GdReg = \"Brasil\") %>%\n  select(GdReg, mes, Tipo, Media)\n\nMed_Geral <- Med_GdReg_data %>%\n  bind_rows(Med_Pais_geral) %>%\n  mutate(GdReg = factor(GdReg, levels = c(\"Brasil\", \"N\", \"NE\", \"SE\", \"S\", \"CO\")))\n\n```\n\n## Produção dos gráficos estáticos\n\n### Tema\nCarrega configurações de tema para os gráficos, desenvolvido pro Atlas Nacional Digital.\n```{r}\n#| warning: false\n\nshowtext_auto()\nshowtext_opts(dpi = 300)\nfont_add(family = \"univers\", regular = \"C:/Windows/Fonts/univer.TTF\")\n\ntheme_set(\n  theme_igray() + \n    theme(plot.title = element_text(family = \"univers\", face = \"bold\", size = 11, hjust = 0.5, vjust = 0.5, lineheight = 1.1, margin = margin(12, 0, 12, 0)),\n          legend.position = \"bottom\",\n          legend.title = element_blank(),\n          legend.background = element_rect(fill = \"white\"),\n          legend.text = element_text(family = \"univers\", face = \"plain\", size = 9, margin = margin(0, 15, 0, 5)),\n          legend.key.width = unit(1.5, \"cm\"),\n          plot.background = element_rect(fill = \"#d0cece\"),\n          plot.margin = margin(t = 0, r = 40, b = 0, l = 10 ),\n          axis.title = element_text(family = \"univers\", face = \"plain\", size = 9),\n          axis.text = element_text(family = \"univers\", face = \"plain\", size = 7)))\n\ncores <- c(\"#000000\", brewer.pal(5, \"Set1\"))\nnames(cores) <- c(\"Brasil\", levels(Med_GdReg_data$GdReg))\ncolScale <- scale_color_manual(name = \"GdReg\", labels = c(\"Brasil\", \"Norte\", \"Nordeste\", \"Sudeste\", \"Sul\", \"Centro-Oeste\"), values = cores)\nlineScale <- scale_linetype_manual(name = \"GdReg\", labels = c(\"Brasil\", \"Norte\", \"Nordeste\", \"Sudeste\", \"Sul\", \"Centro-Oeste\"), values = c(2, 1, 1, 1, 1, 1))\n\n```\n\n### Alertas Hidrológicos\n```{r}\n#| label: fig-hidro\n#| fig-cap: Hidrológico\n\ngraf_hidro <- Med_Geral %>%\n  filter(Tipo == \"hidro\") %>%\n  ggplot(aes(x = mes, y = Media, colour = GdReg, group = GdReg, linetype = GdReg)) +\n  geom_line(stat = \"identity\", position = \"identity\", size = 0.8, ) +\n  labs(title = \"Média mensal de alertas de risco hidrológico,\\npor Grandes Regiões - 2012-2021\") +\n  xlab(\"Mês\") +\n  ylab(\"Alertas\") +\n  lineScale +\n  colScale +\n  theme(legend.margin = margin(0, 40, 0, 40))\n\ngraf_hidro\n```\n\n### Alertas Geológicos\n```{r}\n#| label: fig-geo\n#| fig-cap: Geológico\n\ngraf_geo <- Med_Geral %>%\n  filter(Tipo == \"geo\") %>%\n  ggplot(aes(x = mes, y = Media, colour = GdReg, group = GdReg, linetype = GdReg)) +\n  geom_line(stat = \"identity\", position = \"identity\", size = 0.8, ) +\n  labs(title = \"Média mensal de alertas de risco geológico,\\npor Grandes Regiões - 2012-2021\") +\n  xlab(\"Mês\") +\n  ylab(\"Alertas\") +\n  lineScale +\n  colScale +\n  theme(legend.margin = margin(0, 40, 0, 40))\n\ngraf_geo\n```\n\n### Alertas\nAinda tenho que ver como definir o tamanho individual das figuras. Por enquanto tá definido globalmente, no início do documento, e em polegadas, eca.\n```{r}\n#| label: fig-geral\n#| fig-cap: Geral\n\ngraf_geral <- Med_Geral %>%\n  filter(Tipo == \"Event\") %>%\n  arrange(GdReg) %>%\n  ggplot(aes(x = mes, y = Media, colour = GdReg, group = GdReg, linetype = GdReg)) +\n  geom_line(size = 0.5) +\n  labs(title = \"Média mensal de alertas de risco geohidrológico,\\npor Grandes Regiões - 2012-2021\") +\n  xlab(\"Mês\") +\n  ylab(\"Alertas\") +\n  lineScale +\n  colScale +\n  theme(legend.margin = margin(0, 40, 0, 40)) +\n  facet_wrap(vars(GdReg), nrow = 1)\n\ngraf_geral\n```\n\nDá pra referenciar as imagens no texto, @fig-hidro, @fig-geo e @fig-geral.\n\n## Interatividade\nExistem muitas possibilidades de interatividade, em tabelas, gráficos e mapas. Teste primeiramente a produção de mapas, que me parece mais complexa. Para obter a interatividade rodando direto do navegador, deve-se utilizar o [**Observable**](https://observablehq.com/). Infelizmente o *proxy* do IBGE bloqueia! Vou pedir pra DI liberar depois.\n\n### Bibliotecas\nCarrega a biblioteca *bertin.js* para a produção de mapas\n```{ojs}\n\nbertin = require(\"bertin\")\n```\n\n### Fonte de dados\nCarrega o JSON servido pelo serviço WFS do geoserver do IBGE. Ver [aqui](https://geoservicos.ibge.gov.br/geoserver/web/wicket/bookmarkable/org.geoserver.web.demo.MapPreviewPage?1&filter=false) a lista de serviços disponbibilizada pelo IBGE. Tem bastante coisa! No caso das BATERs, elas já vêm com os variáveis da publicação, além da geometria. A grande vantagem de usar o serviço wfs é não precisar manter as camadas espaciais que forem utilizadas na parte interativa no repositório do site, economizando muito espaço de armazenamento.\n```{ojs}\n\njsonURL = \"https://geoservicos.ibge.gov.br/geoserver/CGEO/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=CGEO%3APARBR2018_BATER_MD&maxFeatures=600000&outputFormat=application%2Fjson\"\n\nbater = d3.json(jsonURL)\n```\n\n### Input\nAqui é criado a caixinha de seleção do município. O ideal é fazer um de UF antes pra reduzir a lista resultante. Depois eu faço, na camada WFS das BATERs não tem a sigla da UF, só o geocódigo, mais difícil de escolher a UF né. Só botar uma tabelinha com isso e fazer o join que resolve.\n```{ojs}\n\nviewof selmun = Inputs.select(\n  bater.features.map((d) => d.properties.municipio),\n  {\n    sort: true,\n    unique: true,\n    label: \"Município\"\n  }\n)\n\nmunicipioArray = bater.features.filter((d) => d.properties.municipio == selmun)\n```\n\n### Filtragem\nAqui as feições são filtradas segundo o município selecionado. O correto na verdade é aplicar o filtro antes de requisitar a camada wfs pra diminuir o tráfego de dados. Do jeito que está demora para carregar inicialmente o mapa, tem todo o tempo de recebimento da camada completa wfs do IBGE. Depois eu vejo como fazer.\n```{ojs}\n\nmunicipio = ({\n  \"type\":\"FeatureCollection\",\n  \"features\":municipioArray  \n})\n```\n\n### Mapa\nAqui produz o mapa com as BATERs do município selecionado. A biblioteca [*bertin*](https://observablehq.com/collection/@neocartocnrs/bertin) é mais pra produzir cartogramas, não dá pra \"passear\" pelo mapa. Mas pode-se fazer, por exemplo, janelinhas *pop up* com os dados da BATER que aparecem ao clicar na mesma. Existem outras bibliotecas para trabalhar com mapas, a [*plot*](https://observablehq.com/@observablehq/plot) que é parecida com a *bertin*, e algumas de mapas mesmo, [*openlayer*](https://observablehq.com/@mbostock/hello-openlayers), [*leaflet*](https://observablehq.com/@tmcw/leaflet) e [*mapbox*](https://observablehq.com/@tmcw/using-mapbox-gl-js). Devo utilizar no final a a *openlayer* ou a *leaflet*.\n\nAlém de mapas, dá pra produzir as tabelas interativas (a pessoa pode filtrar por qualquer campo, por exemplo, e ordenar por qualquer coluna) e gráficos também. E tudo isso rodando no navegador, sem precisar de um servidor com interpretador de *R* ou *Python* instalados, com as bibliotecas como *Shiny* ou *Dash* nas versões certas e dispor de tempo de processador para processar as ações de todos os usuários simultâneos... O servidor só precisa servir o site, e nada mais. \n```{ojs}\n\nsimplemap = bertin.draw({\n  params: { background: \"#bde1f0\", margin: 10 },\n  layers: [{\n      type: \"layer\",\n      geojson: municipio,\n      fill: \"#ff0000\",\n      stroke: \"#ff0000\",\n      strokeWidth: 1,\n      symbol: \"square\",\n      symbol_size: 50\n    },\n    {\n      type: \"tiles\",\n      opacity: 1,\n      style: \"openstreetmap\",\n    }\n  ]\n})\n\n\n```"},"formats":{"html":{"execute":{"fig-width":5,"fig-height":4,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","theme":"cosmo","title":"Teste de funcionalidade ***Quarto***\npara sítio eletrônico com recursos interativos","author":"Joaquim","date":"12/19/2022"},"extensions":{"book":{"multiFile":true}}}}}